<html>
<head>
  <style>
    button {
      margin-bottom: 0.5rem;
    }
    .form-control {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }
  </style>
  <script>
    async function postRequest(url, data = {}) {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      console.log(`POST ${url}`, data)
      return response.json()
    }

    function updateViewAfterList(items) {
      const itemContainer = document.getElementById('item-container')
      while (itemContainer.firstChild) {
        itemContainer.removeChild(itemContainer.firstChild);
      }
      for (let item of items) {
        item.date = new Date(item.date)
      }
      items.sort((a, b) => b.date - a.date)

      let year = null
      for (let item of items) {
        let itemYear = item.date.getFullYear()
        if (year == null || year > itemYear) {
          let yearHeading = document.createElement('h1')
          yearHeading.innerText = itemYear
          itemContainer.appendChild(yearHeading)
          year = itemYear
        }

        let div = document.createElement('div')
        let title = document.createElement('h2')
        title.innerText = item.name
        title.style.cursor = 'pointer'
        title.addEventListener('click', () => {
          console.log(`choose item ${item.id}: "${item.name}"`)
          window.zzz.currentItemId = item.id
        })
        div.appendChild(title)

        let author = document.createElement('h3')
        author.innerText = item.author
        div.appendChild(author)

        let desc = document.createElement('p')
        desc.innerText = item.description
        div.appendChild(desc)

        itemContainer.appendChild(div)
      }
    }

    function updateViewAfterAdd(item) {
      console.log(item)
    }

    function updateViewAfterDelete(item) {
      window.zzz.currentItemId = 0
      onListItems()
    }

    function onListItems() {
      postRequest('list-items').then(updateViewAfterList)
    }

    function onAddItem(item) {
      postRequest('add-item', item).then(updateViewAfterAdd)
    }

    function deleteCurrentItem() {
      postRequest('delete-item', {itemId: window.zzz.currentItemId}).then(updateViewAfterDelete)
    }

    window.addEventListener('load', (event) => {
      window.zzz = {} /* start with empty context */
      onListItems()

      /* Hook up event handlers */

      let addItemForm = document.getElementById("add-item-form")
      addItemForm.addEventListener("submit", e => {
        e.preventDefault()
        new FormData(e.target)
        e.target.reset()
      })
      addItemForm.addEventListener("formdata", e => {
        let item = {}
        for (let v of e.formData) {
          item[v[0]] = v[1]
        }
        onAddItem(item)
      })

      let deleteItemButton = document.getElementById("delete-item-button")
      deleteItemButton.addEventListener("click", e => {
        e.preventDefault()
        deleteCurrentItem()
      })
    })
  </script>
</head>
<body style="display: flex; margin: 0; padding: 0;">
  <div id="item-container" style="flex: 9; padding: 1em">
  </div>
  <div style="flex: 3; background-color: lightgray; padding: 1em; display: flex; flex-direction: column; justify-content: space-between;">
    <form style="display: flex; flex-direction: column;">
      <div class="form-control">
        <label for="date">Date</label>
        <input id="date" name="date" type="date"/>
      </div>

      <div class="form-control">
        <label for="name">Name</label>
        <input id="name" name="name"/>
      </div>

      <div class="form-control">
        <label for="author">Author</label>
        <input id="author" name="author"/>
      </div>

      <div class="form-control">
        <label for="description">Description</label>
        <textarea id="description" name="description" style="resize: none;"></textarea>
      </div>
      <button>Update</button>
      <button id="delete-item-button" style="background-color:tomato">Delete</button>
    </form>
    <form id="add-item-form" style="display: flex; flex-direction: column;">
      <div class="form-control">
        <label for="date">Date</label>
        <input id="date" name="date" type="date"/>
      </div>

      <div class="form-control">
        <label for="name">Name</label>
        <input id="name" name="name"/>
      </div>

      <div class="form-control">
        <label for="author">Author</label>
        <input id="author" name="author"/>
      </div>

      <div class="form-control">
        <label for="description">Description</label>
        <textarea id="description" name="description" style="resize: none;"></textarea>
      </div>
      <button type"submit">Add</button>
    </form>
  </div>
</body>
